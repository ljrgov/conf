// https://git.repcz.link/raw.githubusercontent.com/ljrgov/conf/refs/heads/main/singbox/substore~rule-for-singbox.js#type=ç»„åˆè®¢é˜…&name=sublink&outbound=ğŸ•³â„¹ï¸ğŸ‡­ğŸ‡° æ¸¸æˆèŠ‚ç‚¹ğŸ·â„¹ï¸^.*ğŸ‡­ğŸ‡°.*æ¸¸æˆ.*$ğŸ•³â„¹ï¸ğŸ‡¯ğŸ‡µ æ¸¸æˆèŠ‚ç‚¹ğŸ·â„¹ï¸^.*ğŸ‡¯ğŸ‡µ.*æ¸¸æˆ.*$ğŸ•³â„¹ï¸ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹ğŸ·â„¹ï¸^(?=.*(?:ğŸ‡­ğŸ‡°|é¦™æ¸¯|HK|Hong Kong))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸ‡¨ğŸ‡³ å°æ¹¾èŠ‚ç‚¹ğŸ·â„¹ï¸^(?=.*(?:ğŸ‡¨ğŸ‡³|ğŸ‡¹ğŸ‡¼|å°æ¹¾|TW|Taiwan))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹ğŸ·â„¹ï¸^(?=.*(?:ğŸ‡¯ğŸ‡µ|æ—¥æœ¬|JP|Tokyo|Japan))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹ğŸ·â„¹ï¸^(?=.*(?:ğŸ‡ºğŸ‡¸|US|United States))(?!(?:.*Premium|.*æ¸¸æˆ|.*nx)).*$ğŸ•³â„¹ï¸ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹ğŸ·â„¹ï¸^(?=.*(?:ğŸ‡¸ğŸ‡¬|æ–°åŠ å¡|SG|Singapore))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸ° æ¬§æ´²åŒºåŸŸğŸ·â„¹ï¸^(?=.*(?:ğŸ‡¬ğŸ‡§|ğŸ‡«ğŸ‡·|ğŸ‡©ğŸ‡ª|ğŸ‡®ğŸ‡¹|ğŸ‡ªğŸ‡¸|ğŸ‡µğŸ‡¹|ğŸ‡³ğŸ‡±|ğŸ‡¸ğŸ‡ª|ğŸ‡³ğŸ‡´|ğŸ‡«ğŸ‡®|ğŸ‡©ğŸ‡°|ğŸ‡¨ğŸ‡­|ğŸ‡§ğŸ‡ª|ğŸ‡µğŸ‡±|ğŸ‡¨ğŸ‡¿|ğŸ‡·ğŸ‡´|ğŸ‡ºğŸ‡¦|ğŸ‡¬ğŸ‡·|ğŸ‡·ğŸ‡º|ğŸ‡ªğŸ‡º))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸ¦… ç¾æ´²åŒºåŸŸğŸ·â„¹ï¸^(?=.*(?:ğŸ‡¨ğŸ‡¦|ğŸ‡²ğŸ‡½|ğŸ‡§ğŸ‡·|ğŸ‡¦ğŸ‡·|ğŸ‡¨ğŸ‡´|ğŸ‡µğŸ‡ª|ğŸ‡¨ğŸ‡±|ğŸ‡ºğŸ‡¾|ğŸ‡»ğŸ‡ª|ğŸ‡ªğŸ‡¨|ğŸ‡µğŸ‡¾|ğŸ‡¬ğŸ‡¹|ğŸ‡©ğŸ‡´|ğŸ‡¨ğŸ‡º|ğŸ‡§ğŸ‡´|ğŸ‡­ğŸ‡³|ğŸ‡³ğŸ‡®|ğŸ‡¯ğŸ‡²))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸ‰ äºšæ´²åŒºåŸŸğŸ·â„¹ï¸^(?=.*(?:ğŸ‡°ğŸ‡·|ğŸ‡»ğŸ‡³|ğŸ‡¹ğŸ‡­|ğŸ‡®ğŸ‡³|ğŸ‡µğŸ‡°|ğŸ‡²ğŸ‡¾|ğŸ‡®ğŸ‡©|ğŸ‡¸ğŸ‡¦|ğŸ‡®ğŸ‡·|ğŸ‡¹ğŸ‡·|ğŸ‡µğŸ‡­|ğŸ‡°ğŸ‡µ|ğŸ‡±ğŸ‡°|ğŸ‡°ğŸ‡¿|ğŸ‡¦ğŸ‡¿|ğŸ‡²ğŸ‡´|ğŸ‡·ğŸ‡º))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸª˜ éæ´²åŒºåŸŸğŸ·â„¹ï¸^(?=.*(?:ğŸ‡ªğŸ‡¬|ğŸ‡¿ğŸ‡¦|ğŸ‡³ğŸ‡¬|ğŸ‡°ğŸ‡ª|ğŸ‡ªğŸ‡¹|ğŸ‡¬ğŸ‡­|ğŸ‡²ğŸ‡¦|ğŸ‡¹ğŸ‡¿|ğŸ‡ºğŸ‡¬|ğŸ‡©ğŸ‡¿|ğŸ‡¸ğŸ‡³|ğŸ‡¨ğŸ‡®|ğŸ‡²ğŸ‡±|ğŸ‡¨ğŸ‡²|ğŸ‡¹ğŸ‡³|ğŸ‡²ğŸ‡¿|ğŸ‡¿ğŸ‡¼|ğŸ‡¦ğŸ‡´|ğŸ‡¸ğŸ‡©))(?!(?:.*Premium|.*æ¸¸æˆ|.*tg)).*$ğŸ•³â„¹ï¸ğŸ” æ‰‹åŠ¨é€‰æ‹©ğŸ·â„¹ï¸^(?!.*(?:ğŸ‡­ğŸ‡°|ğŸ‡¨ğŸ‡³|ğŸ‡¹ğŸ‡¼|ğŸ‡¯ğŸ‡µ|ğŸ‡ºğŸ‡¸|ğŸ‡¸ğŸ‡¬|æ¸¯|å°æ¹¾|æ—¥æœ¬|ç¾å›½|æ–°åŠ å¡|HK|CN|TW|JP|US|SG|Hong|Taiwan|Tokyo|Japan|Singapore|United States)).*$


// ç¤ºä¾‹è¯´æ˜

// https://raw.githubusercontent.com/xream/scripts/main/surge/modules/sub-store-scripts/sing-box/template.js#type=ç»„åˆè®¢é˜…&name=æœºåœº&outbound=ğŸ•³â„¹ï¸all|all-autoğŸ•³â„¹ï¸hk|hk-autoğŸ·â„¹ï¸æ¸¯|hk|hongkong|kong kong|ğŸ‡­ğŸ‡°ğŸ•³â„¹ï¸tw|tw-autoğŸ·â„¹ï¸å°|tw|taiwan|ğŸ‡¹ğŸ‡¼ğŸ•³â„¹ï¸jp|jp-autoğŸ·â„¹ï¸æ—¥æœ¬|jp|japan|ğŸ‡¯ğŸ‡µğŸ•³â„¹ï¸sg|sg-autoğŸ·â„¹ï¸^(?!.*(?:us)).*(æ–°|sg|singapore|ğŸ‡¸ğŸ‡¬)ğŸ•³â„¹ï¸us|us-autoğŸ·â„¹ï¸ç¾|us|unitedstates|united states|ğŸ‡ºğŸ‡¸

// ç¤ºä¾‹è¯´æ˜
// è¯»å– åç§°ä¸º "æœºåœº" çš„ ç»„åˆè®¢é˜… ä¸­çš„èŠ‚ç‚¹(å•è®¢é˜…ä¸éœ€è¦è®¾ç½® type å‚æ•°)
// æŠŠ æ‰€æœ‰èŠ‚ç‚¹æ’å…¥åŒ¹é… /all|all-auto/i çš„ outbound ä¸­(è·Ÿåœ¨ ğŸ•³ åé¢, â„¹ï¸ è¡¨ç¤ºå¿½ç•¥å¤§å°å†™, ä¸ç­›é€‰èŠ‚ç‚¹ä¸éœ€è¦ç»™ ğŸ· )
// æŠŠåŒ¹é… /æ¸¯|hk|hongkong|kong kong|ğŸ‡­ğŸ‡°/i  (è·Ÿåœ¨ ğŸ· åé¢, â„¹ï¸ è¡¨ç¤ºå¿½ç•¥å¤§å°å†™) çš„èŠ‚ç‚¹æ’å…¥åŒ¹é… /hk|hk-auto/i çš„ outbound ä¸­
// ...
// å¯é€‰å‚æ•°: includeUnsupportedProxy åŒ…å«å®˜æ–¹/å•†åº—ç‰ˆä¸æ”¯æŒçš„åè®® SSR. ç”¨æ³•: `&includeUnsupportedProxy=true`

// æ”¯æŒä¼ å…¥è®¢é˜… URL. å‚æ•°ä¸º url. è®°å¾— url éœ€è¦ encodeURIComponent.
// ä¾‹å¦‚: http://a.com?token=123 åº”ä½¿ç”¨ url=http%3A%2F%2Fa.com%3Ftoken%3D123

// âš ï¸ å¦‚æœ outbounds ä¸ºç©º, è‡ªåŠ¨åˆ›å»º COMPATIBLE(direct) å¹¶æ’å…¥ é˜²æ­¢æŠ¥é”™
log(`ğŸš€ å¼€å§‹`)

let { type, name, outbound, includeUnsupportedProxy, url } = $arguments

log(`ä¼ å…¥å‚æ•° type: ${type}, name: ${name}, outbound: ${outbound}`)

type = /^1$|col|ç»„åˆ/i.test(type) ? 'collection' : 'subscription'

const parser = ProxyUtils.JSON5 || JSON
log(`â‘  ä½¿ç”¨ ${ProxyUtils.JSON5 ? 'JSON5' : 'JSON'} è§£æé…ç½®æ–‡ä»¶`)
let config
try {
  config = parser.parse($content ?? $files[0])
} catch (e) {
  log(`${e.message ?? e}`)
  throw new Error(`é…ç½®æ–‡ä»¶ä¸æ˜¯åˆæ³•çš„ ${ProxyUtils.JSON5 ? 'JSON5' : 'JSON'} æ ¼å¼`)
}
log(`â‘¡ è·å–è®¢é˜…`)

let proxies
if (url) {
  log(`ç›´æ¥ä» URL ${url} è¯»å–è®¢é˜…`)
  proxies = await produceArtifact({
    name,
    type,
    platform: 'sing-box',
    produceType: 'internal',
    produceOpts: {
      'include-unsupported-proxy': includeUnsupportedProxy,
    },
    subscription: {
      name,
      url,
      source: 'remote',
    },
  })
} else {
  log(`å°†è¯»å–åç§°ä¸º ${name} çš„ ${type === 'collection' ? 'ç»„åˆ' : ''}è®¢é˜…`)
  proxies = await produceArtifact({
    name,
    type,
    platform: 'sing-box',
    produceType: 'internal',
    produceOpts: {
      'include-unsupported-proxy': includeUnsupportedProxy,
    },
  })
}

log(`â‘¢ outbound è§„åˆ™è§£æ`)
const outbounds = outbound
  .split('ğŸ•³')
  .filter(i => i)
  .map(i => {
    let [outboundPattern, tagPattern = '.*'] = i.split('ğŸ·')
    const tagRegex = createTagRegExp(tagPattern)
    log(`åŒ¹é… ğŸ· ${tagRegex} çš„èŠ‚ç‚¹å°†æ’å…¥åŒ¹é… ğŸ•³ ${createOutboundRegExp(outboundPattern)} çš„ outbound ä¸­`)
    return [outboundPattern, tagRegex]
  })

log(`â‘£ outbound æ’å…¥èŠ‚ç‚¹`)
config.outbounds.map(outbound => {
  outbounds.map(([outboundPattern, tagRegex]) => {
    const outboundRegex = createOutboundRegExp(outboundPattern)
    if (outboundRegex.test(outbound.tag)) {
      if (!Array.isArray(outbound.outbounds)) {
        outbound.outbounds = []
      }
      const tags = getTags(proxies, tagRegex)
      log(`ğŸ•³ ${outbound.tag} åŒ¹é… ${outboundRegex}, æ’å…¥ ${tags.length} ä¸ª ğŸ· åŒ¹é… ${tagRegex} çš„èŠ‚ç‚¹`)
      outbound.outbounds.push(...tags)
    }
  })
})

const compatible_outbound = {
  tag: 'COMPATIBLE',
  type: 'direct',
}

let compatible
log(`â‘¤ ç©º outbounds æ£€æŸ¥`)
config.outbounds.map(outbound => {
  outbounds.map(([outboundPattern, tagRegex]) => {
    const outboundRegex = createOutboundRegExp(outboundPattern)
    if (outboundRegex.test(outbound.tag)) {
      if (!Array.isArray(outbound.outbounds)) {
        outbound.outbounds = []
      }
      if (outbound.outbounds.length === 0) {
        if (!compatible) {
          config.outbounds.push(compatible_outbound)
          compatible = true
        }
        log(`ğŸ•³ ${outbound.tag} çš„ outbounds ä¸ºç©º, è‡ªåŠ¨æ’å…¥ COMPATIBLE(direct)`)
        outbound.outbounds.push(compatible_outbound.tag)
      }
    }
  })
})

config.outbounds.push(...proxies)

$content = JSON.stringify(config, null, 2)

function getTags(proxies, regex) {
  return (regex ? proxies.filter(p => regex.test(p.tag)) : proxies).map(p => p.tag)
}
function log(v) {
  console.log(`[ğŸ“¦ sing-box æ¨¡æ¿è„šæœ¬] ${v}`)
}
function createTagRegExp(tagPattern) {
  return new RegExp(tagPattern.replace('â„¹ï¸', ''), tagPattern.includes('â„¹ï¸') ? 'i' : undefined)
}
function createOutboundRegExp(outboundPattern) {
  return new RegExp(outboundPattern.replace('â„¹ï¸', ''), outboundPattern.includes('â„¹ï¸') ? 'i' : undefined)
}

log(`ğŸ”š ç»“æŸ`)